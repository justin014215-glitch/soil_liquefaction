{% extends 'base.html' %}

{% block title %}開始分析 - {{ project.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-play"></i> 開始液化分析</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'liquefaction:index' %}">首頁</a></li>
                <li class="breadcrumb-item"><a href="{% url 'liquefaction:project_list' %}">我的專案</a></li>
                <li class="breadcrumb-item"><a href="{% url 'liquefaction:project_detail' project.pk %}">{{ project.name }}</a></li>
                <li class="breadcrumb-item active">開始分析</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> 分析確認</h5>
            </div>
            <div class="card-body">
                <p>您即將對專案 <strong>{{ project.name }}</strong> 執行液化分析。</p>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-chart-bar"></i> 資料摘要</h6>
                    <ul class="mb-0">
                        <li>鑽孔數量：{{ boreholes_count }} 個</li>
                        <li>土層數量：{{ layers_count }} 個</li>
                        <li>預設方法：{{ project.get_analysis_method_display }}</li>
                        <li>錘擊效率：{{ project.em_value }}%</li>
                    </ul>
                </div>

                <!-- 新增：分析方法選擇 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0"><i class="fas fa-calculator"></i> 選擇分析方法</h6>
                    </div>
                    <div class="card-body">
                        <form method="post" id="analysisForm">
                            {% csrf_token %}
                            <div class="row">
                                {% for method_code, method_name in available_methods %}
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="analysis_methods" value="{{ method_code }}" 
                                               id="method_{{ method_code }}"
                                               {% if method_code == project.analysis_method %}checked{% endif %}>
                                        <label class="form-check-label" for="method_{{ method_code }}">
                                            <strong>{{ method_name }}</strong>
                                            {% if method_code == project.analysis_method %}
                                            <small class="text-primary">(預設)</small>
                                            {% endif %}
                                        </label>
                                        <div class="form-text">
                                            {% if method_code == 'HBF' %}
                                            適用於台灣地區的液化評估方法，考慮細料含量修正
                                            {% elif method_code == 'NCEER' %}
                                            國際廣泛使用的標準方法，基於 SPT-N 值評估
                                            {% elif method_code == 'AIJ' %}
                                            日本建築學會制定的液化評估方法
                                            {% elif method_code == 'JRA' %}
                                            日本道路協會制定的液化評估方法
                                            {% else %}
                                            可靠的液化評估方法
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="all_methods" onchange="toggleAllMethods()">
                                        <label class="form-check-label" for="all_methods">
                                            <strong>全部方法都執行</strong>
                                            <small class="text-muted">- 一次性執行所有分析方法</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>注意：</strong>
                    <ul class="mb-0">
                        <li>分析過程可能需要數分鐘時間</li>
                        <li>分析期間請勿關閉瀏覽器</li>
                        <li>可以選擇多個方法同時執行</li>
                        <li>現有的分析結果將被覆蓋</li>
                    </ul>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'liquefaction:project_detail' project.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回
                    </a>
                    <button type="submit" form="analysisForm" class="btn btn-analyze btn-lg" onclick="return validateAndSubmit()">
                        <i class="fas fa-play"></i> 開始分析
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-lightbulb"></i> 分析方法說明</h6>
            </div>
            <div class="card-body">
                <h6>各方法特色：</h6>
                <div class="accordion" id="methodAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingHBF">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHBF">
                                HBF (2012)
                            </button>
                        </h2>
                        <div id="collapseHBF" class="accordion-collapse collapse" data-bs-parent="#methodAccordion">
                            <div class="accordion-body">
                                <small>適用於台灣地區的液化評估方法，特別考慮細料含量對液化抗力的影響，推薦用於台灣地區的工程分析。</small>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingNCEER">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNCEER">
                                NCEER (2001)
                            </button>
                        </h2>
                        <div id="collapseNCEER" class="accordion-collapse collapse" data-bs-parent="#methodAccordion">
                            <div class="accordion-body">
                                <small>國際廣泛使用的標準方法，基於大量的現地案例資料建立，適用於全球範圍的液化評估。</small>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingAIJ">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAIJ">
                                AIJ (2001)
                            </button>
                        </h2>
                        <div id="collapseAIJ" class="accordion-collapse collapse" data-bs-parent="#methodAccordion">
                            <div class="accordion-body">
                                <small>日本建築學會制定的方法，特別適用於建築工程的液化評估，考慮日本地震特性。</small>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingJRA">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseJRA">
                                JRA (1996)
                            </button>
                        </h2>
                        <div id="collapseJRA" class="accordion-collapse collapse" data-bs-parent="#methodAccordion">
                            <div class="accordion-body">
                                <small>日本道路協會制定的方法，主要用於道路工程的液化評估，重視工程安全性。</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">分析項目：</h6>
                <ul class="list-unstyled">
                    <li>• 設計地震液化潛能</li>
                    <li>• 中小地震液化潛能</li>
                    <li>• 最大地震液化潛能</li>
                    <li>• 安全係數計算</li>
                    <li>• 液化潛能指數 (LPI)</li>
                </ul>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>建議：</strong>如果不確定選擇哪種方法，可以選擇「全部方法都執行」，然後在結果頁面比較不同方法的差異。
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全部方法選擇功能
function toggleAllMethods() {
    const allCheckbox = document.getElementById('all_methods');
    const methodCheckboxes = document.querySelectorAll('input[name="analysis_methods"]');
    
    methodCheckboxes.forEach(checkbox => {
        checkbox.checked = allCheckbox.checked;
    });
}

// 監聽個別方法checkbox的變化
document.querySelectorAll('input[name="analysis_methods"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allCheckbox = document.getElementById('all_methods');
        const methodCheckboxes = document.querySelectorAll('input[name="analysis_methods"]');
        const checkedMethods = document.querySelectorAll('input[name="analysis_methods"]:checked');
        
        // 如果所有方法都選中，則勾選"全部方法"
        if (checkedMethods.length === methodCheckboxes.length) {
            allCheckbox.checked = true;
        } else {
            allCheckbox.checked = false;
        }
    });
});

// 驗證選擇並提交
function validateAndSubmit() {
    const selectedMethods = document.querySelectorAll('input[name="analysis_methods"]:checked');
    
    if (selectedMethods.length === 0) {
        alert('請至少選擇一種分析方法！');
        return false;
    }
    
    const methodNames = Array.from(selectedMethods).map(cb => 
        cb.parentElement.querySelector('label strong').textContent
    );
    
    const confirmMessage = `確定要執行以下分析方法嗎？\n\n${methodNames.join('\n')}\n\n分析可能需要數分鐘時間，請耐心等候。`;
    
    return confirm(confirmMessage);
}
</script>
{% endblock %}